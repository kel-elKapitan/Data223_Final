def create_combined_csv(directory):

    # This function combines CSV files and reformats the data to a normalised format

    # Initialize an empty DataFrame to store the combined data
    combined_df = pd.DataFrame()

    # Iterate over the files in the directory
    for file_name in os.listdir(directory):
        
        if file_name.endswith('.csv'):
            # Construct the full file path
            file_path = os.path.join(directory, file_name)

            # Parse cohort and date from the file name
            split_name = file_name.split('_')
            cohort = split_name[0] + '_' + split_name[1]

            #print(cohort)
            date = split_name[2].split('.')[0]

            # Read the CSV file
            df = pd.read_csv(file_path)

            # Iterate over the unique weeks present in the column names
            for week in range(1, 9):
                # Select the relevant columns for the current week
                week_df = df[['name', 'trainer',
                          f'Analytic_W{week}', f'Independent_W{week}',
                          f'Determined_W{week}', f'Professional_W{week}',
                          f'Studious_W{week}', f'Imaginative_W{week}']].copy()

                # Rename the columns
                week_df.columns = ['name', 'trainer',
                               'Analytic', 'Independent',
                               'Determined', 'Professional',
                               'Studious', 'Imaginative']

                # Add a 'week' column
                week_df['week'] = week

                # Append the current week DataFrame to the combined DataFrame
                combined_df = pd.concat([combined_df, week_df], ignore_index=True)

    # Add the 'cohort' and 'date' columns to the combined DataFrame
    combined_df['cohort'] = cohort
    combined_df['date'] = date

    # Remove rows with any missing values
    combined_df.dropna(inplace=True)

    # Save the combined DataFrame to a new CSV file
    combined_file_path = os.path.join(directory, 'combined_data.csv')
    combined_df.to_csv(combined_file_path, index=False)

    return combined_df


# Define the path to the directory containing the CSV files
directory = 'Sparta'

create_combined_csv(directory)
